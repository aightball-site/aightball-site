<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIght Ball – Coming Soon</title>
  <style>
    :root{
      --bg:#0d0d0d; --fg:#f2f2f2; --muted:#bbbbbb; --card:#111111; --border:#333;
      --accent:#33cc99; --accent-hover:#2ab386; --triW:160px; --triH:140px;
      --bold:#2dd4bf; --bold-ink:#05201c;
      --caut:#f2c94c; --caut-ink:#221c08;
      --neut:#7aa0b4; --neut-ink:#07131a;
      --myst:#a78bfa; --myst-ink:#1a0f2b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:Arial,Helvetica,sans-serif;
      background:radial-gradient(1200px 800px at 50% -10%, #1a1a1a, var(--bg));
      color:var(--fg); min-height:100vh; display:grid;
      grid-template-rows:auto auto 1fr auto; align-items:start;
    }

    /* Hero */
    .hero{ display:grid; place-items:center; padding:2.25rem 1.25rem 0.75rem; }
    .hero img{
      width:min(70vw,500px); max-height:45vh; object-fit:contain; border-radius:24px;
      box-shadow:0 30px 80px rgba(0,0,0,.5); user-select:none; -webkit-user-drag:none;
    }

    /* Demo container */
    .demo{
      margin:0.5rem auto 0; padding:1.5rem 1.25rem 2rem; border:1px solid var(--border);
      border-radius:20px; width:min(92vw, 720px); background:linear-gradient(180deg,#121212,var(--card));
      box-shadow:0 24px 50px rgba(0,0,0,.35);
    }

    /* Orb */
    .oracle-wrap{ position:relative; display:grid; place-items:center; margin-bottom:1rem; padding:1rem 0; overflow:visible; }
    .mist, .mist::before, .mist::after{
      content:""; position:absolute; pointer-events:none; width:520px; height:520px; border-radius:50%; filter:blur(26px);
      background:
        radial-gradient(120px 120px at 30% 40%, rgba(51,204,153,.12), transparent 10%),
        radial-gradient(180px 180px at 70% 30%, rgba(100,180,255,.10), transparent 10%),
        radial-gradient(140px 140px at 50% 70%, rgba(255,255,255,.06), transparent 10%);
      animation:drift 18s ease-in-out infinite; opacity:.6; transform:translate3d(0,0,0);
    }
    .mist{ top:-40px; left:50%; transform:translateX(-50%); }
    .mist::before{ top:-30px; left:-80px; animation-duration:22s; animation-direction:reverse; }
    .mist::after{ top:10px; left:80px; animation-duration:26s; opacity:.5; }
    @keyframes drift{ 0%{transform:translate(-50%,0) rotate(0);opacity:.55}50%{transform:translate(-48%,-8px) rotate(6deg);opacity:.8}100%{transform:translate(-50%,0) rotate(0);opacity:.55}}

    .eightball{
      position:relative; width:min(68vw,360px); height:min(68vw,360px); border-radius:50%;
      background:radial-gradient(circle at 35% 30%, #2b2b2b 0%, #111 55%, #000 100%);
      box-shadow:inset 0 -20px 40px rgba(0,0,0,.7), 0 30px 60px rgba(0,0,0,.45);
      display:grid; place-items:center; overflow:hidden; transition:transform .2s cubic-bezier(.2,.8,.2,1);
    }
    .eightball::before{
      content:""; position:absolute; top:6%; left:12%; width:40%; height:28%;
      background:radial-gradient(ellipse at top left, rgba(255,255,255,.22), rgba(255,255,255,0));
      filter:blur(4px); transform:rotate(-12deg); pointer-events:none;
    }
    .window{ position:relative; width:50%; height:50%; border-radius:50%;
      background:radial-gradient(circle at 50% 40%, #0b1b27, #03121c 60%, #01090e 100%);
      box-shadow:inset 0 0 40px rgba(0,0,0,.9); display:grid; place-items:center;
      border:2px solid #0f2a3a; overflow:hidden;
    }
    .window::before{ content:""; position:absolute; inset:0; border-radius:50%;
      background:radial-gradient(circle, transparent 70%, rgba(0,0,0,.7) 100%); pointer-events:none; z-index:1;
    }
    .triangle{ position:absolute; left:50%; top:58%; transform:translate(-50%,-50%); width:0; height:0;
      border-left:calc(var(--triW)/2) solid transparent; border-right:calc(var(--triW)/2) solid transparent;
      border-top:var(--triH) solid #163a5a; filter:drop-shadow(0 6px 10px rgba(0,0,0,.6));
    }
    .triangle .msg{
      position:absolute; left:50%; top:calc(-1 * var(--triH) * 0.72); transform:translateX(-50%);
      width:calc(var(--triW) * 0.8); text-align:center; font-weight:800; font-size:1.05rem; letter-spacing:.5px;
      color:#cde7ff; text-shadow:0 1px 0 rgba(0,0,0,.5); line-height:1.2; margin:0 auto;
    }

    /* Ask row */
    .qa{ display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin:1rem 0 .25rem; }
    .helper{ color:var(--muted); margin:.25rem 0 .75rem; text-align:center; }

    /* Main reading hero card */
    .main-card{
      border:1px solid rgba(51,204,153,.45);
      background:linear-gradient(180deg, rgba(51,204,153,.08), #0f1312);
      border-radius:16px;
      padding:1rem 1rem 1.1rem;
      box-shadow:0 10px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
      margin:0 auto 0.75rem;
    }
    .main-header{
      display:flex; align-items:center; gap:.75rem; margin-bottom:.4rem;
    }
    .pill{
      display:inline-flex; align-items:center; gap:.35rem; font-weight:700; padding:.15rem .6rem; border-radius:999px;
      background:var(--accent); color:#04110d; font-size:.82rem;
    }
    .main-odds{
      margin-left:auto; font-weight:900; font-size:1.15rem; letter-spacing:.4px;
    }
    .main-body{
      line-height:1.5; font-size:1.02rem; color:#e8e8e8;
    }

    /* Scrollable responses */
    .responses-wrap{ margin-top:.75rem; border:1px solid var(--border); border-radius:14px; background:#121212; max-height:260px; overflow:auto; padding:.5rem; }
    .responses-grid{ display:grid; grid-template-columns:1fr; gap:.5rem; }
    @media(min-width:680px){ .responses-grid{ grid-template-columns:1fr 1fr; } }

    .persona-card{
      position:relative; border:1px solid var(--border); border-radius:12px; padding:.85rem .95rem .9rem;
      background:linear-gradient(180deg, #141414, #0f0f0f);
      transition:transform .06s ease, box-shadow .15s ease, border-color .15s ease;
      cursor:pointer;
    }
    .persona-card:hover{ transform:translateY(-1px); box-shadow:0 8px 16px rgba(0,0,0,.25); }
    .persona-card h4{ margin:0 0 .35rem; font-size:.95rem; letter-spacing:.4px; display:flex; align-items:center; gap:.5rem; }
    .persona-card .pill{ background:var(--accent); color:#04110d; }
    .persona-card .odds{ font-weight:700; margin:.35rem 0 .4rem; }
    .persona-card p{ margin:0; color:#e3e3e3; line-height:1.45; white-space:pre-wrap; }

    /* Persona colorways */
    .card--bold{ background:linear-gradient(180deg, rgba(45,212,191,.10), #0e1716); border-color:rgba(45,212,191,.35); }
    .card--bold h4{ color:var(--bold); }
    .card--bold .pill{ background:var(--bold); color:var(--bold-ink); }

    .card--caut{ background:linear-gradient(180deg, rgba(242,201,76,.10), #19160a); border-color:rgba(242,201,76,.35); }
    .card--caut h4{ color:var(--caut); }
    .card--caut .pill{ background:var(--caut); color:var(--caut-ink); }

    .card--neut{ background:linear-gradient(180deg, rgba(122,160,180,.12), #0f1417); border-color:rgba(122,160,180,.35); }
    .card--neut h4{ color:var(--neut); }
    .card--neut .pill{ background:var(--neut); color:var(--neut-ink); }

    .card--myst{ background:linear-gradient(180deg, rgba(167,139,250,.12), #130f19); border-color:rgba(167,139,250,.35); }
    .card--myst h4{ color:var(--myst); }
    .card--myst .pill{ background:var(--myst); color:var(--myst-ink); }

    /* Skeleton state */
    .skeleton{ position:relative; overflow:hidden; }
    .skeleton .line{ height:12px; background:#1b1b1b; border-radius:6px; margin:.4rem 0; }
    .skeleton .line.wide{ width:92%; } .skeleton .line.med{ width:75%; } .skeleton .line.short{ width:55%; }
    .skeleton::after{
      content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent);
      animation:shimmer 1.2s infinite;
    }
    @keyframes shimmer{ 0%{transform:translateX(-100%);} 100%{transform:translateX(100%);} }

    input[type="email"], input[type="text"]{
      padding:.85rem .9rem; border:none; border-radius:10px; min-width:280px; background:#1a1a1a; color:#fff; outline:1px solid var(--border);
    }
    button{
      padding:.9rem 1.2rem; border:none; border-radius:12px; background:var(--accent); color:#02120d; font-weight:700; cursor:pointer;
      transition:background .15s ease, transform .08s ease, box-shadow .15s ease; box-shadow:0 8px 18px rgba(51,204,153,.25);
    }
    button:hover{ background:var(--accent-hover); }
    button:active{ transform:translateY(1px); }

    /* Signup centered */
    .signup{
      display:flex; justify-content:center; align-items:center; gap:.6rem;
      margin:1.25rem auto 0; width:min(92vw,720px);
    }

    footer{ margin:1.25rem 0 1.5rem; text-align:center; color:#8a8a8a; font-size:.95rem; }
    a{ color:var(--accent); text-decoration:none; } a:hover{ text-decoration:underline; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    @keyframes wobble{
      0%{transform:rotate(0) translateX(0)}20%{transform:rotate(3deg) translateX(6px)}
      40%{transform:rotate(-3deg) translateX(-6px)}60%{transform:rotate(2deg) translateX(4px)}
      80%{transform:rotate(-2deg) translateX(-4px)}100%{transform:rotate(0) translateX(0)}
    }
    .shake{ animation:wobble .6s ease-in-out; }

    .window::after{
      content:""; position:absolute; inset:-99%; opacity:.05;
      background:
        radial-gradient(120px 120px at 30% 40%, rgba(100,180,255,.12), transparent 60%),
        radial-gradient(160px 160px at 70% 70%, rgba(51,204,153,.20), transparent 60%),
        radial-gradient(200px 200px at 50% 30%, rgba(255,255,255,.06), transparent 65%);
      filter:blur(18px) saturate(1.05); mix-blend-mode:screen; animation:swirl 22s ease-in-out infinite; pointer-events:none; border-radius:50%;
      clip-path:circle(50% at 50% 50%);
    }
    .triangle::after{
      content:""; position:absolute; left:50%; top:calc(-1 * var(--triH)); transform:translateX(-50%);
      width:var(--triW); height:var(--triH); clip-path:polygon(50% 0%, 100% 100%, 0% 100%);
      background:
        radial-gradient(200px 200px at 65% 60%, rgba(180,220,255,.20), transparent 40%),
        radial-gradient(200px 200px at 65% 75%, rgba(51,204,153,.20), transparent 40%);
      filter:blur(10px); mix-blend-mode:screen; opacity:.7; animation:swirl 18s ease-in-out infinite reverse; pointer-events:none;
    }
    @keyframes swirl{ 0%{transform:translateX(-50%) rotate(0);opacity:.6}50%{transform:translateX(-50%) rotate(5deg);opacity:.85}100%{transform:translateX(-50%) rotate(0);opacity:.6} }

    /* outcome border tints */
    .demo.tint-good{ border-color:#2ea86b; }
    .demo.tint-mixed{ border-color:#bda32e; }
    .demo.tint-risky{ border-color:#c24d4d; }

    .regen-hint{ font-size:.78rem; color:var(--muted); margin-top:.35rem; }
  </style>
</head>
<body>
  <!-- HERO -->
  <section class="hero" aria-label="AIght Ball">
    <img src="Images/Logo.jpg" alt="AIght Ball logo"/>
  </section>

  <!-- DEMO -->
  <section id="demo" class="demo" role="region" aria-label="AIght Ball demo">
    <div class="oracle-wrap">
      <div class="mist"></div>
      <div id="orb" class="eightball" aria-hidden="true">
        <div class="window">
          <div class="triangle">
            <div id="orb-msg" class="msg">ASK A QUESTION</div>
          </div>
        </div>
      </div>
    </div>

    <form id="question-form" class="qa" autocomplete="off">
      <label class="sr-only" for="user-question">Ask a question</label>
      <input id="user-question" type="text" name="question" placeholder="Ask anything—decisions, dilemmas, ideas…" maxlength="200"/>
      <button type="submit" aria-label="Ask AIght Ball">Ask</button>
      <button type="button" id="shake-btn" aria-label="Shake the ball">Shake It</button>
    </form>
    <p class="helper">Tip: press Enter to ask. Or just shake for a random reading.</p>

    <!-- Prominent main reading -->
    <div id="main-card" class="main-card" role="status" aria-live="polite">
      <div class="main-header">
        <span class="pill pill--primary">AIght Ball</span>
        <div id="demo-odds" class="main-odds">🎲 Odds: --%</div>
      </div>
      <div id="demo-text" class="main-body">✨ Waiting for your question…</div>
    </div>

    <!-- Scrollable multi-persona responses -->
    <div class="responses-wrap" aria-live="polite">
      <div id="responses" class="responses-grid"></div>
    </div>
  </section>

  <!-- Signup (centered) -->
  <form class="signup" name="signup" method="POST" data-netlify="true">
    <input type="email" name="email" placeholder="Enter your email for early access" required/>
    <button type="submit">Notify Me</button>
  </form>

  <footer>
    © 2025 AIght Ball · Follow us on
    <a href="https://instagram.com/aightball.io" target="_blank" rel="noopener">Instagram</a> &
    <a href="https://youtube.com/@aightballio" target="_blank" rel="noopener">YouTube</a>
  </footer>

<script>
  /* ================== DOM HOOKS ================== */
  const orb = document.getElementById('orb');
  const orbMsg = document.getElementById('orb-msg');
  const oddsOut = document.getElementById('demo-odds');
  const textOut = document.getElementById('demo-text');
  const inputEl = document.getElementById('user-question');
  const askBtn = document.querySelector('#question-form button[type="submit"]');
  const shakeBtn = document.getElementById('shake-btn');
  const responsesEl = document.getElementById('responses');
  const demoWrap = document.getElementById('demo');

  /* ================== PERSONAS ================== */
  const PERSONAS = [
    {
      id:'bold', label:'Bold', color:'var(--bold)',
      priorities:['action','momentum','clarity'],
      avoids:['hedging','over-qualifying'],
      voice:'Confident, vivid, concise. Short sentences when urging action.',
      heuristics:'>60% = decisive next step; 40–60% = small experiment with tight scope; <40% = defer or shrink task.',
    },
    {
      id:'cautious', label:'Cautious', color:'var(--caut)',
      priorities:['risk control','containment','timing'],
      avoids:['grand plans','overexposure'],
      voice:'Measured, calm, and supportive. Encourages containment and timing.',
      heuristics:'>60% = bounded move with pre-set limits; 40–60% = triage and plan; <40% = pause and protect energy.',
    },
    {
      id:'neutral', label:'Neutral / Practical', color:'var(--neut)',
      priorities:['clarity','order','incremental progress'],
      avoids:['drama','fluff'],
      voice:'Grounded and pragmatic, “what moves the needle?” tone.',
      heuristics:'>60% = pick the most practical lever; 40–60% = organize and schedule; <40% = leave breadcrumbs for future self.',
    },
    {
      id:'mystic', label:'Mystic', color:'var(--myst)',
      priorities:['intuition','timing','lightness'],
      avoids:['forcing outcomes','overthinking'],
      voice:'Gentle, poetic hints; emphasizes tides, synchronicity, and stopping one step early.',
      heuristics:'>60% = follow the “green light” and end early; 40–60% = send a light signal and wait; <40% = rest and let clarity arrive.',
    },
  ];

  /* ================== UTILITIES ================== */
  function shakeOrb(){
    orb.classList.remove('shake'); void orb.offsetWidth; orb.classList.add('shake');
  }
  function clamp(n,a=0,b=1){ return Math.min(b, Math.max(a,n)); }

  function renderPersonaSkeletons(){
    responsesEl.innerHTML = '';
    PERSONAS.forEach(p=>{
      const card = document.createElement('div');
      card.className = `persona-card skeleton ${cardClass(p.id)}`;
      card.innerHTML = `
        <h4><span class="pill">${p.label}</span></h4>
        <div class="line wide"></div>
        <div class="line med"></div>
        <div class="line short"></div>
        <div class="regen-hint">Generating…</div>
      `;
      responsesEl.appendChild(card);
    });
  }

  function setLoading(on){
    askBtn.disabled = on; shakeBtn.disabled = on;
    if(on){
      orbMsg.textContent = "…";
      oddsOut.textContent = "🎲 Odds: —";
      textOut.textContent = "✨ Consulting the orb…";
      renderPersonaSkeletons();
    }
  }

  function createCard({persona, label, odds, long, onClick}){
    const div = document.createElement('div');
    div.className = `persona-card ${cardClass(persona)}`;
    div.innerHTML = `
      <h4><span class="pill">${label}</span></h4>
      <div class="odds">Odds: ${Number.isFinite(odds) ? odds + '%' : '--'}</div>
      <p>${long}</p>
      <div class="regen-hint">Tap to regenerate this voice</div>
    `;
    div.addEventListener('click', onClick);
    return div;
  }

  function cardClass(id){
    return id==='bold' ? 'card--bold' :
           id==='cautious' ? 'card--caut' :
           id==='neutral' ? 'card--neut' : 'card--myst';
  }

  function fallback(){
    return { short:"62%", long:"A proactive move is likely to pay off, provided you keep scope contained.", odds:62 };
  }

  // Turn a single 0–100 positive odds into 4 persona buckets summing to 100
  function splitPersonaShares(posOdds){
    const p = clamp(posOdds/100);
    const amb = 1 - Math.abs(p - 0.5)*2; // ambiguity high near 50/50
    let wBold = 0.55*p + 0.10*amb;
    let wCaut = 0.55*(1-p) + 0.10*amb;
    let wNeutral = 0.80*amb;
    let wMystic = Math.max(0, 1 - (wBold+wCaut+wNeutral));
    const S = wBold+wCaut+wNeutral+wMystic || 1;
    let arr = [wBold/S, wCaut/S, wNeutral/S, wMystic/S].map(x=>Math.round(x*100));
    let diff = 100 - arr.reduce((a,b)=>a+b,0);
    while(diff!==0){
      const idx = diff>0 ? arr.indexOf(Math.max(...arr)) : arr.indexOf(Math.min(...arr));
      arr[idx] += diff>0 ? 1 : -1; diff = 100 - arr.reduce((a,b)=>a+b,0);
    }
    return { bold:arr[0], cautious:arr[1], neutral:arr[2], mystic:arr[3] };
  }

  function tintBorder(posOdds){
    demoWrap.classList.remove('tint-good','tint-mixed','tint-risky');
    if (posOdds >= 60) demoWrap.classList.add('tint-good');
    else if (posOdds <= 40) demoWrap.classList.add('tint-risky');
    else demoWrap.classList.add('tint-mixed');
  }

  /* =============== Topic & Lead line =============== */
  function detectTopic(q){
    const s = (q||'').toLowerCase(); const has=(...w)=>w.some(x=>s.includes(x));
    if (has('email','inbox','reply','work','monday','case','meeting','deck','presentation')) return 'work';
    if (has('dinner','eat','meal','food','cook','restaurant','matcha','ramen')) return 'food';
    if (has('relationship','date','partner','spouse','family','friend','text them','call')) return 'relationship';
    if (has('gym','run','workout','health','sleep','hydrate','walk','yoga')) return 'health';
    if (has('money','budget','buy','sell','invest','crypto','stock','cost','price')) return 'money';
    if (has('video','stream','write','script','record','edit','channel','shorts','lofi','song')) return 'creative';
    if (has('trip','travel','flight','hotel','book','drive','commute')) return 'travel';
    if (has('party','hang','friends','event','invite')) return 'social';
    return 'general';
  }
  function pickTimebox(odds){
    if (odds >= 75) return '45 minutes';
    if (odds >= 55) return '25 minutes';
    if (odds >= 35) return '15 minutes';
    return '10 minutes';
  }
  function overallRuling(odds, topic){
    const p = Number(odds)||50;
    const lead = p>=70 ? 'A strong tailwind favors action.'
      : p>=55 ? 'Momentum leans your way if you keep scope tight.'
      : p>45 ? 'It could go either way—small bets beat grand plans.'
      : p>30 ? 'Headwinds ahead; progress is possible with guardrails.'
      : 'Tonight likely isn’t the move—protect energy and set a clean start.';
    const garnish = ({
      work:' Aim for visible progress, not inbox zero.',
      food:' Decide once, plate simply, and enjoy it.',
      relationship:' Lead with one clear ask or appreciation.',
      health:' Choose a gentle win over a heroic push.',
      money:' Decide the limit first, then act—or wait.',
      creative:' Ship a sketch, not a symphony.',
      travel:' Lock one decision and close the tab.',
      social:' Set a vibe and a boundary.',
      general:''
    })[topic] || '';
    return `${lead}${garnish}`;
  }

  /* ============ BACKEND BRIDGE (enhanced) ============ */
  function buildPersonaPrompt(question, odds, topic, persona){
    return {
      mode: 'persona_narrative_v1',
      instruction: 'Write a distinct 4–6 sentence micro-story outcome for this question. Use the persona’s heuristics and voice; do not write generic advice. Start concrete, end with a crisp stop. Avoid repeating stock phrases.',
      question, odds, topic,
      persona: {
        id: persona.id, label: persona.label,
        priorities: persona.priorities, avoids: persona.avoids,
        voice: persona.voice, heuristics: persona.heuristics
      },
      guidance: {
        timebox: pickTimebox(odds),
        must_avoid: ['“consider energy and boundaries”','boilerplate hedges','lists'],
        style: 'concise, image-light, specific next step if appropriate'
      }
    };
  }

  async function fetchReading(payload){
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), 20000);
    try{
      const resp = await fetch("/api/reading", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      const data = await resp.json().catch(()=>null);
      return data || null;
    }catch(e){
      return null;
    }finally{
      clearTimeout(timer);
    }
  }

  async function fetchBase(question){
    return await fetchReading({ question });
  }

  async function fetchPersonaNarrative(question, odds, topic, persona){
    const controls = buildPersonaPrompt(question, odds, topic, persona);
    const res = await fetchReading({ question, persona: persona.id, controls });
    const txt = typeof res?.narrative === 'string' && res.narrative.trim()
      ? res.narrative.trim()
      : (typeof res?.long === 'string' && res.long.trim() ? res.long.trim() : null);
    return txt;
  }

  /* ============ CLIENT-SIDE SYNTH (fallback only) ============ */
  function synthesizeNarrative(personaId, odds, topic){
    const tb = pickTimebox(odds);
    const p = Number(odds)||50;
    const positive = p >= 60, negative = p <= 40;
    const seed = {
      bold: {
        pos: [`You move first and let momentum do the heavy lifting. In ${tb}, you notch a visible win and stop before the slope turns sticky.`],
        mid: [`You pick one lever and pull it clean. Small, sharp progress in ${tb} beats a fuzzy plan.`],
        neg: [`You try once, then protect the evening. The win tonight is discipline, not volume.`]
      },
      cautious: {
        pos: [`You fence the task and keep it tidy. ${tb} of focused effort, pre-capped risk, and a clean stop.`],
        mid: [`You triage, schedule, and leave the heavy lift for a clearer head. Order first, execution later.`],
        neg: [`You pause without guilt. Fires-only scan, then rest buys you better odds tomorrow.`]
      },
      neutral: {
        pos: [`You choose the most practical move in ${tb} and remove one snag. Clarity compounds.`],
        mid: [`You organize the board so the next step is obvious. The map matters more than mileage tonight.`],
        neg: [`You leave breadcrumbs for morning-you and close the tab. Progress is prevention.`]
      },
      mystic: {
        pos: [`A green light appears—you follow it lightly, then stop a step early. Leaving a spark invites it back.`],
        mid: [`You send a gentle signal and listen. The right path answers when the noise fades.`],
        neg: [`Your gut says “not yet.” You honor it. Sleep is a collaborator.`]
      }
    };
    const pack = seed[personaId] || seed.neutral;
    const arr = positive ? pack.pos : negative ? pack.neg : pack.mid;
    const base = arr[Math.floor(Math.random()*arr.length)];
    const topicTails = {
      work:` Tomorrow starts with fewer snags.`,
      food:` The plate is simple; the mind follows.`,
      relationship:` Connection beats control.`,
      health:` Recovery counts as training.`,
      money:` Rules over impulse.`,
      creative:` You’ll post with a clear lens.`,
      travel:` Decision beats tab sprawl.`,
      social:` Warmth with a boundary wins.`,
      general:``
    };
    return `${base} ${topicTails[topic]||''}`.trim();
  }

  /* ================== MAIN FLOW ================== */
  function renderAllPersonas(question, odds, topic){
    responsesEl.innerHTML = '';
    const shares = splitPersonaShares(odds);
    const shareMap = { bold:shares.bold, cautious:shares.cautious, neutral:shares.neutral, mystic:shares.mystic };

    PERSONAS.forEach(p=>{
      const placeholder = document.createElement('div');
      placeholder.className = `persona-card skeleton ${cardClass(p.id)}`;
      placeholder.innerHTML = `
        <h4><span class="pill">${p.label}</span></h4>
        <div class="line wide"></div><div class="line med"></div><div class="line short"></div>
        <div class="regen-hint">Generating…</div>
      `;
      responsesEl.appendChild(placeholder);

      (async()=>{
        let narrative = await fetchPersonaNarrative(question, odds, topic, p);
        if(!narrative) narrative = synthesizeNarrative(p.id, odds, topic);

        const card = createCard({
          persona: p.id,
          label: p.label,
          odds: shareMap[p.id],
          long: narrative,
          onClick: async ()=>{
            const fresh = await fetchPersonaNarrative(question, odds, topic, p) || synthesizeNarrative(p.id, odds, topic);
            card.querySelector('p').textContent = fresh;
          }
        });
        placeholder.replaceWith(card);
      })();
    });
  }

  async function askAightBall(question){
    setLoading(true);
    try{
      const baseData = await fetchBase(question);
      const f = fallback();
      const odds = Number.isFinite(Number(baseData?.odds))
        ? Math.max(0, Math.min(100, Math.round(baseData.odds)))
        : 50;
      const topic = detectTopic(question);

      const overall = overallRuling(odds, topic);
      const short = /^\d{1,3}%$/.test(String(baseData?.short)) ? String(baseData.short) : `${odds}%`;

      oddsOut.textContent = `🎲 Odds: ${odds}%`;
      textOut.textContent = `✨ ${overall}`;
      orbMsg.textContent = short;
      shakeOrb();
      tintBorder(odds);

      renderAllPersonas(question, odds, topic);
    }catch(e){
      const f = fallback();
      oddsOut.textContent = `🎲 Odds: ${f.odds}%`;
      textOut.textContent = `✨ ${f.long}`;
      orbMsg.textContent = f.short;
      shakeOrb();

      responsesEl.innerHTML = '';
      PERSONAS.forEach(p=>{
        responsesEl.appendChild(createCard({
          persona: p.id,
          label: p.label,
          odds: f.odds,
          long: synthesizeNarrative(p.id, f.odds, 'general'),
          onClick: ()=>{}
        }));
      });
      console.warn("AIght Ball fallback (timeout/network).");
    }finally{
      setLoading(false);
    }
  }

  /* ================== EVENTS ================== */
  document.getElementById('shake-btn').addEventListener('click', ()=>{
    const q = inputEl.value.trim() || "Surprise me";
    askAightBall(q);
  });
  document.getElementById('question-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const q = inputEl.value.trim() || "Surprise me";
    askAightBall(q);
  });
</script>
</body>
</html>














